# Story 4.2: Automatic Production Deployment Pipeline

## Status

- **Current Phase:** Draft
- **Assigned Developer:** TBD
- **Story Points:** 5
- **Epic:** Epic 4 - CI/CD & DevOps Enhancement
- **Dependencies:** Story 4.1 (Quality Gates) completion
- **Estimated Completion:** 3-4 days

## User Story

**As a** SCISS platform developer and maintainer  
**I want** automatic deployment to production when code is merged to the main branch after passing all quality gates  
**So that** Epic 1 & 2 enhancements are deployed rapidly and reliably without manual intervention, reducing deployment friction and human error.

## Background Context

**Current Deployment Process**: SCISS currently requires manual workflow dispatch to deploy to production via GitHub Actions `manual-deploy.yml`. While this provides safety, it creates deployment friction and delays for Epic 1 & 2 feature delivery.

**Existing Infrastructure**: The project has solid CI/CD foundations:

- Automated testing and validation in `develop.yml`
- Manual deployment workflow with SSH to Hostinger
- Quality gate integration from Story 4.1
- Existing deployment scripts and SSH configuration

**Business Impact**: Manual deployment delays mean Epic 1 & 2 improvements (better user interactions, accessibility enhancements, modern components) reach users more slowly. Automatic deployment after quality gate validation ensures rapid, reliable delivery of educational platform improvements.

## Acceptance Criteria

### ✅ **AC1: Automatic Main Branch Deployment**

- [ ] Automatic deployment triggers on successful merge to main branch
- [ ] Deployment only proceeds after all quality gates from Story 4.1 pass
- [ ] Deployment process uses existing SSH-based rsync method to Hostinger
- [ ] Deployment includes both main content and video assets (with size optimization)
- [ ] Failed deployments do not affect the main branch merge process

### ✅ **AC2: Deployment Safety & Approval Gates**

- [ ] Optional manual approval gate for initial rollout (configurable via repository settings)
- [ ] Deployment can be paused or cancelled during execution
- [ ] Previous deployment artifact preserved for quick rollback capability
- [ ] Production deployment runs in isolated environment with proper secrets management
- [ ] Deployment process provides real-time progress updates and logging

### ✅ **AC3: Deployment Notification & Visibility**

- [ ] Deployment start/success/failure notifications sent to configured channels
- [ ] Deployment status visible in GitHub repository (badges, status checks)
- [ ] Deployment logs and artifacts available for troubleshooting
- [ ] Deployment timing and performance metrics collected and reported
- [ ] Git commit and deployment correlation maintained for debugging

### ✅ **AC4: Integration with Quality Gates & Rollback**

- [ ] Quality gates from Story 4.1 must pass before deployment proceeds
- [ ] Quality gate failures prevent deployment with clear error reporting
- [ ] Automatic rollback triggered by critical quality gate failures post-deployment
- [ ] Manual rollback capability available through GitHub Actions interface
- [ ] Rollback process restores previous deployment state within 5 minutes

### ✅ **AC5: Developer Experience & Fallback**

- [ ] Existing manual deployment workflow remains available as fallback
- [ ] Clear documentation for troubleshooting deployment issues
- [ ] Local deployment script (deploy.sh) remains functional for emergency use
- [ ] Deployment configuration easily modified via repository settings
- [ ] Developer feedback loop for deployment process improvements

## Technical Implementation Requirements

### **Enhanced GitHub Actions Workflow**

**New Automatic Deployment Workflow:**

```yaml
# .github/workflows/production-deploy.yml
name: Automatic Production Deployment

on:
  push:
    branches: [main, master]
  workflow_dispatch: # Maintain manual option

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "8"

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production # Use GitHub environments for approval gates

    steps:
      # Build and quality gate validation (from Story 4.1)
      # Deployment execution
      # Health check validation
      # Notification dispatch
```

[Source: .github/workflows/manual-deploy.yml#existing-structure]

**Integration with Story 4.1 Quality Gates:**

```yaml
# Quality gates must pass before deployment
- name: Run Quality Gates
  run: pnpm run quality-gates

- name: Validate Quality Gate Results
  run: |
    if [ ! -f "quality-gates-report.json" ]; then
      echo "Quality gates report not found - deployment blocked"
      exit 1
    fi
```

### **Deployment Safety Mechanisms**

**Pre-deployment Backup:**

```bash
# Create deployment backup before new deployment
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_PATH="backups/deployment_$TIMESTAMP"

ssh -i "$SSH_KEY" -p $SSH_PORT "$REMOTE_USER@$REMOTE_HOST" \
  "mkdir -p $BACKUP_PATH && cp -r $REMOTE_PATH/* $BACKUP_PATH/"
```

**Health Check Integration:**

```bash
# Post-deployment health validation
curl -f "https://sciss.org/health" || {
  echo "Health check failed - initiating rollback"
  ./rollback.sh
  exit 1
}
```

## Tasks

### **Phase 1: Automatic Deployment Workflow (Days 1-2)**

#### **Task 1.1: Production Deployment Workflow Creation**

- [ ] Create `.github/workflows/production-deploy.yml` based on existing manual-deploy.yml
- [ ] Configure automatic trigger on main branch pushes
- [ ] Integrate Story 4.1 quality gates as deployment prerequisite
- [ ] Implement GitHub environments for production with approval gates
- [ ] Configure proper secrets management for SSH deployment
- [ ] Test workflow triggering and quality gate integration locally

#### **Task 1.2: Deployment Safety Implementation**

- [ ] Implement pre-deployment backup creation on Hostinger
- [ ] Create deployment artifact preservation for rollback capability
- [ ] Implement deployment progress logging and status reporting
- [ ] Configure deployment timeout and cancellation capabilities
- [ ] Implement post-deployment health check validation
- [ ] Test complete deployment safety mechanisms

### **Phase 2: Rollback & Recovery Systems (Day 3)**

#### **Task 2.1: Automated Rollback Implementation**

- [ ] Create automated rollback script for deployment failures
- [ ] Implement manual rollback trigger via GitHub Actions
- [ ] Create rollback health verification process
- [ ] Implement rollback notification and logging
- [ ] Test rollback scenarios with simulated deployment failures
- [ ] Document rollback procedures for emergency use

#### **Task 2.2: Integration with Existing Systems**

- [ ] Preserve existing manual deployment workflow as fallback
- [ ] Ensure local deploy.sh script remains functional
- [ ] Update deployment configuration documentation
- [ ] Test compatibility with existing SSH key management
- [ ] Validate no conflicts with existing workflows

### **Phase 3: Notifications & Developer Experience (Day 4)**

#### **Task 3.1: Deployment Notifications & Monitoring**

- [ ] Implement deployment status notifications (start/success/failure)
- [ ] Create deployment badges and status indicators for repository
- [ ] Implement deployment metrics collection and reporting
- [ ] Configure deployment artifact storage and retention
- [ ] Create deployment dashboard or status page integration
- [ ] Test complete notification and monitoring system

#### **Task 3.2: Developer Experience & Documentation**

- [ ] Create comprehensive deployment process documentation
- [ ] Update developer README with automatic deployment information
- [ ] Create troubleshooting guide for deployment issues
- [ ] Implement developer feedback collection for deployment improvements
- [ ] Create deployment process training materials
- [ ] Test complete developer experience from merge to deployment

## Dev Notes

### **Architecture Integration Points**

**Current Deployment Infrastructure:**
[Source: .github/workflows/manual-deploy.yml]

- SSH-based deployment to Hostinger (u356222743@217.21.66.232:65002)
- rsync file synchronization with video optimization
- Environment variable management for production builds
- Existing secrets management for SSH keys

**GitHub Environments Integration:**

```yaml
# Use GitHub environments for approval gates
environment: production
  url: https://sciss.org
  deployments:
    required_reviewers: ["maintainer-username"]
    wait_timer: 0  # No wait time, but can be configured
```

**Deployment Script Enhancement:**

```bash
#!/bin/bash
# Enhanced deployment with safety checks

# Pre-deployment validation
echo "Starting production deployment..."
echo "Commit: $GITHUB_SHA"
echo "Branch: $GITHUB_REF"

# Quality gate validation
if [ ! -f "quality-gates-report.json" ]; then
  echo "ERROR: Quality gates not completed"
  exit 1
fi

# Backup current deployment
BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
echo "Creating backup: $BACKUP_TIMESTAMP"

# Deploy new version
echo "Deploying to production..."
rsync -avz --progress --itemize-changes \
  -e "ssh -i $SSH_KEY -p $SSH_PORT" \
  --exclude='.DS_Store' \
  --exclude='videos/' \
  dist/ "$REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH/"

# Health check
echo "Running post-deployment health check..."
curl -f "https://sciss.org/" || {
  echo "Health check failed - rollback required"
  exit 1
}

echo "Deployment completed successfully"
```

### **Quality Gate Integration**

**Deployment Prerequisite Validation:**

```yaml
# Integration with Story 4.1 quality gates
- name: Validate Quality Gates
  run: |
    # Ensure all quality gates passed
    pnpm run quality-gates

    # Check quality gate report
    node -e "
      const report = require('./quality-gates-report.json');
      if (report.numFailedTests > 0) {
        console.error('Quality gates failed - deployment blocked');
        process.exit(1);
      }
      console.log('All quality gates passed - deployment approved');
    "
```

**Epic 1 & 2 Integration Testing:**

```bash
# Ensure Epic 1 & 2 components pass quality gates
echo "Validating Epic enhancements..."
pnpm run quality-gates:epic1
pnpm run quality-gates:epic2
pnpm run quality-gates:integration
```

### **Rollback Strategy Implementation**

**Automated Rollback Script:**

```bash
#!/bin/bash
# rollback.sh - Automated deployment rollback

BACKUP_DIR="backups"
LATEST_BACKUP=$(ssh -i "$SSH_KEY" -p $SSH_PORT "$REMOTE_USER@$REMOTE_HOST" \
  "ls -t $BACKUP_DIR | head -n1")

if [ -z "$LATEST_BACKUP" ]; then
  echo "ERROR: No backup found for rollback"
  exit 1
fi

echo "Rolling back to: $LATEST_BACKUP"
ssh -i "$SSH_KEY" -p $SSH_PORT "$REMOTE_USER@$REMOTE_HOST" \
  "cp -r $BACKUP_DIR/$LATEST_BACKUP/* $REMOTE_PATH/"

echo "Rollback completed"
```

**Manual Rollback Trigger:**

```yaml
# Manual rollback workflow
name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      backup_timestamp:
        description: "Backup timestamp to rollback to (YYYYMMDD_HHMMSS)"
        required: false
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Execute Rollback
        run: ./rollback.sh ${{ github.event.inputs.backup_timestamp }}
```

## Testing Requirements

### **Deployment Process Testing:**

- [ ] Automatic deployment triggers correctly on main branch merge
- [ ] Quality gate failures properly block deployment
- [ ] Deployment process completes successfully with real artifacts
- [ ] Backup creation and preservation works correctly

### **Rollback System Testing:**

- [ ] Automated rollback triggers on health check failure
- [ ] Manual rollback executes successfully via GitHub Actions
- [ ] Rollback restores previous deployment state correctly
- [ ] Rollback process completes within 5-minute target

### **Integration Testing:**

- [ ] Story 4.1 quality gates integrate seamlessly with deployment
- [ ] Existing manual deployment workflow remains functional
- [ ] Local deploy.sh script continues to work as fallback
- [ ] No conflicts with existing GitHub Actions workflows

### **Notification & Monitoring Testing:**

- [ ] Deployment notifications sent correctly for all scenarios
- [ ] Deployment status indicators update properly
- [ ] Deployment metrics collected and reported accurately
- [ ] Error handling and logging function correctly

## Change Log

| Date       | Version | Changes                                                    | Author           |
| ---------- | ------- | ---------------------------------------------------------- | ---------------- |
| 2024-12-19 | 1.0     | Initial story creation for automatic production deployment | Scrum Master Bob |

---

**Story Validation Checklist:**

- [x] Clear user story with business value identified
- [x] Comprehensive acceptance criteria covering deployment automation
- [x] Detailed task breakdown with realistic time estimates
- [x] Technical implementation guidance with specific code examples
- [x] Integration with Story 4.1 quality gates documented
- [x] Safety mechanisms and rollback procedures defined
- [x] Testing requirements covering all deployment scenarios
- [x] Developer experience and fallback options addressed
