# Story 4.3: Enhanced Environment Management & Preview Deploys

## Status

- **Current Phase:** Draft
- **Assigned Developer:** TBD
- **Story Points:** 6
- **Epic:** Epic 4 - CI/CD & DevOps Enhancement
- **Dependencies:** Story 4.1 (Quality Gates), Story 4.2 (Automatic Deployment)
- **Estimated Completion:** 4-5 days

## User Story

**As a** SCISS platform developer and maintainer  
**I want** staging environments and preview deployments for Epic 1 & 2 feature branches  
**So that** I can test button interactions, form enhancements, Radix UI components, and design system changes in production-like environments before merging to main.

## Background Context

**Current Environment Limitations**: SCISS currently has only production deployment to Hostinger. Testing Epic 1 & 2 enhancements (button states, form validation, Radix UI components) requires local development environments, which don't match production conditions.

**Epic 1 & 2 Testing Needs**:

- **Epic 1**: Button interactions, form validation animations, progressive form features need production-like testing
- **Epic 2**: Radix UI components, design system integration, accessibility compliance require staging validation
- **Cross-Epic Integration**: Animation coordination and design consistency need comprehensive preview testing

**Business Impact**: Without proper staging and preview environments, Epic 1 & 2 regressions could reach production. Preview deploys enable stakeholder review of educational platform improvements before main branch deployment.

## Acceptance Criteria

### ✅ **AC1: Staging Environment Implementation**

- [ ] Dedicated staging environment with production-like configuration
- [ ] Staging deployment automatic on `develop` branch merges
- [ ] Staging environment accessible via subdomain (staging.sciss.org or similar)
- [ ] Staging uses identical build process and deployment method as production
- [ ] Staging environment includes Story 4.1 quality gates validation

### ✅ **AC2: Feature Branch Preview Deployments**

- [ ] Preview deployments created for Epic 1 & 2 feature branches
- [ ] Preview URLs generated automatically for pull requests
- [ ] Preview environments isolated and secure (temporary access tokens)
- [ ] Preview deployments include Epic 1 animations and Epic 2 Radix components
- [ ] Preview deployment URLs included in pull request comments

### ✅ **AC3: Environment Configuration Management**

- [ ] Environment-specific configuration for staging and preview deployments
- [ ] Different API endpoints and settings for staging vs production
- [ ] Staging environment uses test data and configuration
- [ ] Preview environments have reasonable resource limits and cleanup
- [ ] Environment variables properly managed across all deployment types

### ✅ **AC4: Quality Gate Integration Across Environments**

- [ ] Story 4.1 quality gates run on all environment deployments
- [ ] Epic 1 & 2 component testing validated in staging before production
- [ ] Preview deployments include comprehensive quality validation
- [ ] Environment-specific test suites for staging and preview validation
- [ ] Quality gate failures prevent staging and preview deployments

### ✅ **AC5: Developer Experience & Environment Access**

- [ ] Clear documentation for accessing staging and preview environments
- [ ] Environment status dashboard showing staging and active previews
- [ ] Easy environment switching for testing Epic 1 & 2 features
- [ ] Preview environment cleanup and lifecycle management
- [ ] Developer tools for debugging environment-specific issues

## Technical Implementation Requirements

### **Staging Environment Infrastructure**

**Staging Deployment Workflow:**

```yaml
# .github/workflows/staging-deploy.yml
name: Staging Environment Deployment

on:
  push:
    branches: [develop]
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "8"
  STAGING_URL: "staging.sciss.org"

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging

    steps:
      # Build with staging configuration
      # Run quality gates (Story 4.1)
      # Deploy to staging environment
      # Validate Epic 1 & 2 features
```

**Staging Environment Configuration:**

```javascript
// next.config.js - Environment-specific configuration
const config = {
  // Production configuration
  output: "export",
  env: {
    ENVIRONMENT: process.env.NODE_ENV || "production",
    API_URL: process.env.NEXT_PUBLIC_API_URL || "https://sciss.org/api",
    STAGING_MODE: process.env.NODE_ENV === "staging",
  },
};

if (process.env.NODE_ENV === "staging") {
  config.basePath = "/staging";
  config.env.API_URL = "https://staging.sciss.org/api";
}
```

### **Preview Deployment System**

**Preview Deployment Workflow:**

```yaml
# .github/workflows/preview-deploy.yml
name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore: ["**.md", "docs/**"]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: contains(github.head_ref, 'epic-') || contains(github.head_ref, 'story-')

    steps:
      # Build preview version
      # Run Epic 1 & 2 quality gates
      # Deploy to preview environment
      # Comment PR with preview URL
```

**Preview URL Generation:**

```javascript
// Generate unique preview URLs
const previewUrl = `https://preview-${pr.number}-${shortSha}.sciss.org`;
// Or subdirectory approach: `https://sciss.org/preview/${pr.number}`
```

## Tasks

### **Phase 1: Staging Environment Setup (Days 1-2)**

#### **Task 1.1: Staging Infrastructure Configuration**

- [ ] Configure staging subdomain or subdirectory on Hostinger
- [ ] Create staging-specific deployment scripts and configuration
- [ ] Implement staging environment variables and API configuration
- [ ] Set up staging database/content if applicable
- [ ] Configure SSL certificates for staging domain
- [ ] Test staging environment accessibility and basic functionality

#### **Task 1.2: Staging Deployment Workflow**

- [ ] Create `.github/workflows/staging-deploy.yml` for develop branch
- [ ] Integrate Story 4.1 quality gates for staging deployments
- [ ] Implement staging-specific build process and optimization
- [ ] Configure staging environment secrets and deployment keys
- [ ] Implement staging health checks and validation
- [ ] Test complete staging deployment pipeline

### **Phase 2: Preview Deployment System (Days 3-4)**

#### **Task 2.1: Preview Infrastructure Setup**

- [ ] Design preview deployment architecture (subdomains vs subdirectories)
- [ ] Create preview deployment script with unique URL generation
- [ ] Implement preview environment isolation and resource limits
- [ ] Configure preview environment cleanup and lifecycle management
- [ ] Set up preview environment access controls and security
- [ ] Test preview deployment creation and accessibility

#### **Task 2.2: Pull Request Integration**

- [ ] Create `.github/workflows/preview-deploy.yml` for PR trigger
- [ ] Implement PR comment integration with preview URLs
- [ ] Configure preview deployment for Epic 1 & 2 feature branches
- [ ] Integrate Story 4.1 quality gates for preview validation
- [ ] Implement preview deployment status updates in PRs
- [ ] Test complete PR preview workflow

### **Phase 3: Environment Management & Quality Integration (Day 5)**

#### **Task 3.1: Environment Configuration Management**

- [ ] Implement environment-specific configuration system
- [ ] Create environment variable management for staging/preview
- [ ] Configure environment-specific API endpoints and settings
- [ ] Implement environment detection and feature toggles
- [ ] Create environment configuration documentation
- [ ] Test configuration management across all environments

#### **Task 3.2: Quality Gate & Epic Integration**

- [ ] Integrate Epic 1 component testing in staging environment
- [ ] Integrate Epic 2 Radix UI testing in preview environments
- [ ] Implement environment-specific quality gate suites
- [ ] Configure Epic integration testing across environments
- [ ] Implement environment quality reporting and validation
- [ ] Test comprehensive quality integration across environments

## Dev Notes

### **Architecture Integration Points**

**Current Hosting Infrastructure:**
[Source: deploy.sh & .github/workflows/manual-deploy.yml]

- Hostinger shared hosting (domains/sciss.org/public_html)
- SSH-based deployment with rsync
- Static site deployment (Next.js export)
- Video asset management and optimization

**Environment Strategy:**

```bash
# Staging environment structure
domains/
├── sciss.org/public_html/          # Production
├── staging.sciss.org/public_html/  # Staging (if subdomain)
└── sciss.org/public_html/staging/  # Staging (if subdirectory)

# Preview environment structure
domains/sciss.org/public_html/preview/
├── pr-123/     # Preview for PR #123
├── pr-456/     # Preview for PR #456
└── cleanup/    # Automated cleanup scripts
```

**Deployment Script Enhancement:**

```bash
#!/bin/bash
# deploy-environment.sh - Multi-environment deployment

ENVIRONMENT=${1:-production}  # production, staging, preview
PR_NUMBER=${2:-}             # For preview deployments
COMMIT_SHA=${3:-}            # For preview URLs

case $ENVIRONMENT in
  "staging")
    REMOTE_PATH="domains/staging.sciss.org/public_html"
    BUILD_CMD="pnpm run build:staging"
    ;;
  "preview")
    REMOTE_PATH="domains/sciss.org/public_html/preview/pr-$PR_NUMBER"
    BUILD_CMD="pnpm run build:preview"
    ;;
  *)
    REMOTE_PATH="domains/sciss.org/public_html"
    BUILD_CMD="pnpm run build:production"
    ;;
esac

echo "Deploying to $ENVIRONMENT environment..."
$BUILD_CMD
rsync -avz dist/ "$REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH/"
```

### **Epic 1 & 2 Environment Testing**

**Epic 1 Feature Testing in Staging:**

```javascript
// Staging-specific Epic 1 testing
describe("Epic 1 Staging Validation", () => {
  beforeEach(() => {
    cy.visit("https://staging.sciss.org");
  });

  test("button interactions work in staging environment", () => {
    // Test hover, focus, active states in production-like environment
    // Validate animation performance in staging
    // Test form validation animations
  });
});
```

**Epic 2 Component Testing in Preview:**

```javascript
// Preview environment Epic 2 testing
describe("Epic 2 Preview Validation", () => {
  test("Radix UI components function in preview environment", () => {
    // Test Radix form controls accessibility
    // Validate design system token application
    // Test modal and navigation components
  });
});
```

**Environment Quality Gates:**

```yaml
# Environment-specific quality gates
- name: Run Environment Quality Gates
  run: |
    if [ "$ENVIRONMENT" = "staging" ]; then
      pnpm run quality-gates:staging
    elif [ "$ENVIRONMENT" = "preview" ]; then
      pnpm run quality-gates:preview
    fi
```

### **Preview Environment Management**

**Preview Cleanup Strategy:**

```bash
#!/bin/bash
# preview-cleanup.sh - Automated preview cleanup

# Remove previews older than 7 days
find /path/to/preview/ -type d -mtime +7 -name "pr-*" -exec rm -rf {} \;

# Remove previews for closed PRs
for dir in /path/to/preview/pr-*; do
  PR_NUM=$(basename "$dir" | sed 's/pr-//')
  PR_STATE=$(gh pr view "$PR_NUM" --json state -q '.state' 2>/dev/null)

  if [ "$PR_STATE" = "CLOSED" ] || [ "$PR_STATE" = "MERGED" ]; then
    echo "Removing preview for closed PR #$PR_NUM"
    rm -rf "$dir"
  fi
done
```

**Preview URL Comment Template:**

```markdown
## 🌍 Preview Deployment

Your preview deployment is ready!

**Preview URL:** https://sciss.org/preview/pr-{{ pr.number }}

### Epic Features Available:

- ✅ Epic 1: Enhanced button states and form validation
- ✅ Epic 2: Radix UI components and design system
- ✅ Quality Gates: All tests passed

**Commit:** {{ commit.sha }}  
**Updated:** {{ timestamp }}

---

_Preview will be automatically cleaned up when PR is closed_
```

### **Environment Configuration System**

**Environment Detection:**

```javascript
// utils/environment.js
export const getEnvironment = () => {
  if (typeof window !== "undefined") {
    const hostname = window.location.hostname;

    if (hostname.includes("staging")) return "staging";
    if (hostname.includes("preview")) return "preview";
    if (hostname === "localhost") return "development";
    return "production";
  }

  return process.env.NODE_ENV || "production";
};

export const getApiUrl = () => {
  const env = getEnvironment();
  const urls = {
    development: "http://localhost:3000/api",
    staging: "https://staging.sciss.org/api",
    preview: "https://sciss.org/api", // Use production API for previews
    production: "https://sciss.org/api",
  };

  return urls[env];
};
```

## Testing Requirements

### **Environment Deployment Testing:**

- [ ] Staging deployment works correctly from develop branch
- [ ] Preview deployments created successfully for Epic feature branches
- [ ] Environment-specific configuration applied correctly
- [ ] Quality gates run successfully in all environments

### **Epic Feature Environment Testing:**

- [ ] Epic 1 button interactions work correctly in staging
- [ ] Epic 1 form validation animations function in preview environments
- [ ] Epic 2 Radix UI components accessible in all environments
- [ ] Cross-epic integration works correctly in staging

### **Environment Management Testing:**

- [ ] Preview environment cleanup works automatically
- [ ] Environment switching and configuration detection works
- [ ] Preview URL generation and PR integration functions correctly
- [ ] Environment isolation and security measures effective

### **Quality Gate Environment Integration:**

- [ ] Story 4.1 quality gates run successfully in staging
- [ ] Epic-specific quality gates work in preview environments
- [ ] Environment-specific test suites execute correctly
- [ ] Quality gate failures properly block environment deployments

## Change Log

| Date       | Version | Changes                                                    | Author           |
| ---------- | ------- | ---------------------------------------------------------- | ---------------- |
| 2024-12-19 | 1.0     | Initial story creation for enhanced environment management | Scrum Master Bob |

---

**Story Validation Checklist:**

- [x] Clear user story with business value identified
- [x] Comprehensive acceptance criteria covering staging and preview deployments
- [x] Detailed task breakdown with realistic time estimates
- [x] Technical implementation guidance with specific code examples
- [x] Integration with Epic 1 & 2 testing requirements documented
- [x] Environment management and cleanup procedures defined
- [x] Testing requirements covering all environment scenarios
- [x] Quality gate integration addressed for all environments
